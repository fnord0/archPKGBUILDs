# Maintainer: fnord0 <fnord0 AT riseup DOT net>

pkgname=phoenix-miner-svn
pkgver=1
pkgrel=1
pkgdesc="Phoenix miner - efficient, fast, modular, python-based, openCL GPU bitcoin miner"
arch=('i686' 'x86_64')
url="http://forum.bitcoin.org/?topic=6458.0"
license=('Public Domain')
depends=('python2' 'python2-pyopencl' 'twisted' 'boost' 'python2-numpy')
makedepends=('subversion')

_svnroot="http://svn3.xp-dev.com/svn/phoenix-miner/trunk/"
_svnmod="phoenix-miner"

build() {
  if [ -d ${srcdir}/.svn ]; then
    msg 'Updating SVN...'
    svn up ${srcdir} || return 1
  else
    msg 'Checking out SVN...'
    svn co ${_svnroot} ${srcdir} || return 1
  fi
  msg "SVN checkout done or server timeout"
}

package() {
  msg "Creating package..."
  mkdir -p ${pkgdir}/usr/src  || return 1
  mkdir -p ${pkgdir}/usr/share/licenses/${_svnmod} || return 1
  cd ${pkgdir}/usr/src
  cp -R ${srcdir} ${_svnmod} || return 1
  cd ${pkgdir}/usr/src/${_svnmod}
  grep -rl "/usr/bin/python" ${pkgdir}/usr/src/${_svnmod}/ | xargs sed -i 's|/usr/bin/python|/usr/bin/python2|g' || return 1
  chmod 755 ${pkgdir}/usr/src/${_svnmod}/phoenix.py || return 1
  head -22 ${pkgdir}/usr/src/${_svnmod}/phoenix.py > ${pkgdir}/usr/share/licenses/${_svnmod}/LICENSE || return 1
  sed -i '1,2d' ${pkgdir}/usr/share/licenses/${_svnmod}/LICENSE || return 1

  #user notification
  echo -e ""
  echo -e "\e[1;31m[\e[0m\e[1;34m*\e[0m\e[1;31m]\e[0m \e[1;31mrun '\e[0m\e[1;34m/usr/src/phoenix-miner/phoenix.py -h\e[0m\e[1;31m' for an explanation of startup options\e[0m"
  echo -e "\e[1;31m[\e[0m\e[1;34m*\e[0m\e[1;31m]\e[0m \e[1;31man example command-line => '\e[0m\e[1;34mcd /usr/src/phoenix-miner; sudo ./phoenix.py -u http://\e[0m\e[1;31mUSER\e[0m\e[1;34m:\e[0m\e[1;31mPASS\e[0m\e[1;34m@bitcoinpool.com:8332/ -k poclbm DEVICE=0 BFI_INT VECTORS AGGRESSION=11 WORKSIZE=128\e[0m\e[1;31m'\e[0m"
  echo -e "\e[1;34m>>>\e[0m \e[1;31mphoenix miner details @ \e[0m\e[1;32mhttp://forum.bitcoin.org/?topic=6458.0\e[0m"
  echo -e ""
} 
